@model PhoneStore_New.Models.ViewModels.OrderDetailViewModel
@{
    ViewBag.Title = "Chi tiết đơn hàng #" + Model.OrderId;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* CSS Layout Dashboard (Giữ nguyên) */
    .profile-wrapper {
        margin-top: 30px;
        margin-bottom: 60px;
    }

    .list-group-item {
        border-radius: 0;
        border-left: 3px solid transparent;
        transition: 0.2s;
        color: #555;
    }

        .list-group-item:hover {
            background-color: #f9f9f9;
            color: #333;
        }

        .list-group-item.active {
            background-color: #fff;
            color: #d0011b;
            border-color: #ddd;
            border-left: 3px solid #d0011b;
            font-weight: bold;
            z-index: 2;
        }

    .list-group-item-danger {
        color: #d9534f;
    }

        .list-group-item-danger:hover {
            background-color: #f2dede;
            color: #a94442;
        }

    .profile-content {
        background: #fff;
        border: 1px solid #e1e1e1;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }

    .profile-header {
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        background: #fcfcfc;
    }

        .profile-header h3 {
            margin: 0;
            font-size: 18px;
            text-transform: uppercase;
            color: #333;
            font-weight: 700;
        }

    .profile-body {
        padding: 30px;
    }

    .info-group {
        margin-bottom: 20px;
        border-bottom: 1px dashed #eee;
        padding-bottom: 15px;
    }

    .info-label {
        font-weight: bold;
        color: #666;
        width: 150px;
        display: inline-block;
    }

    .table-detail th {
        background: #f9f9f9;
    }

    .total-highlight {
        font-size: 18px;
        color: #d0011b;
        font-weight: bold;
    }

    /* CSS mới cho phần chọn thanh toán */
    .payment-update-box {
        background-color: #f0f8ff;
        padding: 15px;
        border: 1px solid #b0e0e6;
        border-radius: 5px;
        margin-top: 10px;
    }

    .radio-label {
        margin-right: 20px;
        font-weight: normal;
        cursor: pointer;
    }
</style>

<div class="container profile-wrapper">
    <div class="row">
        @* === CỘT TRÁI: MENU === *@
        <div class="col-md-3">
            <div class="list-group shadow-sm">
                <a href="@Url.Action("Index", "Profile")" class="list-group-item">
                    <i class="glyphicon glyphicon-user"></i> Thông tin tài khoản
                </a>
                <a href="@Url.Action("History", "Order")" class="list-group-item active">
                    <i class="glyphicon glyphicon-list-alt"></i> Lịch sử đơn hàng
                </a>
                <a href="@Url.Action("ChangePassword", "Profile")" class="list-group-item">
                    <i class="glyphicon glyphicon-lock"></i> Đổi mật khẩu
                </a>
                <a href="javascript:document.getElementById('logoutForm').submit()" class="list-group-item list-group-item-danger">
                    <i class="glyphicon glyphicon-log-out"></i> Đăng xuất
                </a>
            </div>
        </div>

        @* === CỘT PHẢI: CHI TIẾT ĐƠN HÀNG === *@
        <div class="col-md-9">
            <div class="profile-content">
                <div class="profile-header">
                    <h3><i class="glyphicon glyphicon-file"></i> Chi tiết đơn hàng #@Model.OrderId</h3>
                </div>
                <div class="profile-body">

                    @if (TempData["Message"] != null)
                    {
                        <div class="alert alert-info">@TempData["Message"]</div>
                    }

                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-group">
                                <span class="info-label"><i class="glyphicon glyphicon-calendar"></i> Ngày đặt:</span>
                                <span>@Model.OrderDate.ToString("dd/MM/yyyy HH:mm")</span>
                            </div>

                            @* === PHẦN CHỌN PHƯƠNG THỨC THANH TOÁN (LOGIC MỚI) === *@
                            <div class="info-group">
                                <span class="info-label"><i class="glyphicon glyphicon-credit-card"></i> Thanh toán:</span>

                                @if (Model.Status == "pending")
                                {
                                    using (Html.BeginForm("UpdatePaymentMethod", "Order", FormMethod.Post))
                                    {
                                        @Html.Hidden("orderId", Model.OrderId)
                                        <div class="payment-update-box">
                                            <div style="margin-bottom: 10px;">
                                                <label class="radio-label">
                                                    <input type="radio" name="paymentMethod" value="cod" @(Model.PaymentMethod == "cod" ? "checked" : "")>
                                                    Tiền mặt (COD)
                                                </label>
                                                <label class="radio-label">
                                                    <input type="radio" name="paymentMethod" value="vnpay" @(Model.PaymentMethod == "vnpay" ? "checked" : "")>
                                                    VNPAY
                                                </label>
                                            </div>
                                            <button type="submit" class="btn btn-sm btn-primary">Cập nhật & Thanh toán</button>
                                        </div>
                                    }
                                }
                                else
                                {
                                    // Đã thanh toán hoặc hủy thì hiện text tĩnh
                                    string methodText = "Không xác định";
                                    if (Model.PaymentMethod == "cod") { methodText = "Tiền mặt (COD)"; }
                                    else if (Model.PaymentMethod == "vnpay") { methodText = "VNPAY"; }
                                    else if (Model.PaymentMethod == "transfer") { methodText = "Chuyển khoản"; }

                                    <span>@methodText</span>
                                }
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="info-group">
                                <span class="info-label"><i class="glyphicon glyphicon-map-marker"></i> Giao tới:</span>
                                <span>@Model.ShippingAddress</span>
                            </div>
                            <div class="info-group">
                                <span class="info-label"><i class="glyphicon glyphicon-info-sign"></i> Trạng thái:</span>
                                @{
                                    string statusText = Model.Status;
                                    string color = "#333";
                                    if (Model.Status == "pending") { statusText = "Chờ thanh toán"; color = "#f0ad4e"; }
                                    else if (Model.Status == "cancelled") { statusText = "Đã hủy"; color = "#d9534f"; }
                                    else if (Model.Status == "paid" || Model.Status == "completed") { statusText = "Đã thanh toán"; color = "#5cb85c"; }
                                }
                                <strong style="color: @color">@statusText</strong>
                            </div>
                        </div>
                    </div>

                    <h4 style="margin-top: 30px; margin-bottom: 20px; font-weight: bold; color: #555;">Danh sách sản phẩm</h4>
                    <table class="table table-bordered table-detail">
                        <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th class="text-right">Đơn giá</th>
                                <th class="text-center">Số lượng</th>
                                <th class="text-right">Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Items != null && Model.Items.Any())
                            {
                                foreach (var item in Model.Items)
                                {
                                    <tr>
                                        <td>@item.ProductName</td>
                                        <td class="text-right">@item.PriceAtOrder.ToString("N0")₫</td>
                                        <td class="text-center">x @item.Quantity</td>
                                        <td class="text-right">@item.Subtotal.ToString("N0")₫</td>
                                    </tr>
                                }
                                <tr>
                                    <td colspan="3" class="text-right"><strong>Tổng cộng:</strong></td>
                                    <td class="text-right total-highlight">@Model.TotalAmount.ToString("N0")₫</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <div style="margin-top: 30px;">
                        <a href="@Url.Action("History", "Order")" class="btn btn-default">
                            <i class="glyphicon glyphicon-arrow-left"></i> Quay lại danh sách
                        </a>

                        @if (Model.Status == "pending")
                        {
                            <a href="@Url.Action("Cancel", "Order", new { id = Model.OrderId })" class="btn btn-danger pull-right" onclick="return confirm('Bạn chắc chắn muốn hủy đơn này?')">
                                <i class="glyphicon glyphicon-trash"></i> Hủy đơn hàng
                            </a>
                        }
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

@using (Html.BeginForm("Logout", "Login", FormMethod.Post, new { id = "logoutForm" }))
{@Html.AntiForgeryToken()}