@model IEnumerable<PhoneStore_New.Models.Product>

@{
    ViewBag.Title = "Quản lý sản phẩm";

    // --- KHẮC PHỤC LỖI LAYOUT NOT FOUND ---
    // Tôi để dòng này thành comment (//) để web tự nhận diện Layout mặc định.
    // Nếu giao diện bị trắng trơn, bạn hãy bỏ dấu // và sửa đường dẫn thành "~/Views/Shared/_Layout.cshtml"
    // Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";

    // --- KHẮC PHỤC LỖI COMPILATION ERROR ---
    // Lấy thông báo từ TempData thay vì Model
    string message = TempData["Message"] as string;
}

<div class="row">
    <div class="col-md-12">
        <h2 style="margin-top: 20px; margin-bottom: 20px; font-weight: bold; color: #333;">
            Danh sách sản phẩm
        </h2>

        @* Hiển thị thông báo (An toàn, không lỗi) *@
        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert @(message.Contains("thành công") ? "alert-success" : "alert-danger")" role="alert">
                @message
            </div>
        }

        <div style="margin-bottom: 15px;">
            <a href="@Url.Action("Create")" class="btn btn-primary">
                <i class="glyphicon glyphicon-plus"></i> Thêm mới sản phẩm
            </a>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th style="width: 80px; text-align: center;">Ảnh</th>
                        <th>Tên sản phẩm</th>
                        <th>Giá bán</th>
                        <th>Giảm giá</th>
                        <th>Kho</th>
                        <th style="width: 200px;">Danh mục (Đa chọn)</th>
                        <th style="width: 220px; text-align: center;">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            <tr>
                                <td style="text-align: center; vertical-align: middle;">
                                    <img src="@Url.Content(item.ImageUrl ?? "~/Content/images/no-image.png")"
                                         style="width: 60px; height: 60px; object-fit: contain; border: 1px solid #ddd; padding: 2px;" />
                                </td>
                                <td style="vertical-align: middle; font-weight: 600;">
                                    @Html.DisplayFor(modelItem => item.Name)
                                </td>
                                <td style="vertical-align: middle; color: #d0011b;">
                                    @item.Price.ToString("N0")₫
                                </td>
                                <td style="vertical-align: middle;">
                                    @if (item.DiscountPercentage > 0)
                                    {
                                        <span class="label label-danger">-@item.DiscountPercentage%</span>
                                    }
                                    else
                                    {
                                        <span>-</span>
                                    }
                                </td>
                                <td style="vertical-align: middle;">
                                    @if (item.StockQuantity > 0)
                                    {
                                        <span class="text-success">@item.StockQuantity</span>
                                    }
                                    else
                                    {
                                        <span class="text-danger">Hết hàng</span>
                                    }
                                </td>
                                <td style="vertical-align: middle;">
                                    @* LOGIC HIỂN THỊ ĐA DANH MỤC *@
                                    @if (item.ProductNavbarLinks != null && item.ProductNavbarLinks.Any())
                                    {
                                        foreach (var link in item.ProductNavbarLinks)
                                        {
                                            <span class="label label-info" style="display: inline-block; margin: 2px;">
                                                @link.NavbarItem.ItemText
                                            </span>
                                        }
                                    }
                                    else
                                    {
                                        <span style="color: #999; font-style: italic;">Chưa phân loại</span>
                                    }
                                </td>
                                <td style="text-align: center; vertical-align: middle;">
                                    <a href="@Url.Action("Edit", new { id = item.ProductId })" class="btn btn-warning btn-sm">
                                        <i class="glyphicon glyphicon-pencil"></i> Sửa
                                    </a>
                                    <a href="@Url.Action("Details", new { id = item.ProductId })" class="btn btn-info btn-sm">
                                        <i class="glyphicon glyphicon-eye-open"></i> Xem
                                    </a>
                                    <a href="@Url.Action("Delete", new { id = item.ProductId })" class="btn btn-danger btn-sm">
                                        <i class="glyphicon glyphicon-trash"></i> Xóa
                                    </a>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 20px;">
                                Chưa có sản phẩm nào. Hãy bấm "Thêm mới sản phẩm".
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>