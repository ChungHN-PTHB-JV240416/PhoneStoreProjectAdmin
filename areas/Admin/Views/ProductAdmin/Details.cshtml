@model PhoneStore_New.Models.Product

@{
    ViewBag.Title = "Chi tiết: " + Model.Name;
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="admin-container">
    <div class="row">
        <div class="col-md-12">
            <h2 class="page-header" style="margin-top: 10px;">
                @ViewBag.Title
                <div class="pull-right">
                    <a href="@Url.Action("Edit", new { id = Model.ProductId })" class="btn btn-warning"><i class="glyphicon glyphicon-pencil"></i> Sửa & Nhập kho</a>
                    <a href="@Url.Action("Products")" class="btn btn-default"><i class="glyphicon glyphicon-arrow-left"></i> Quay lại</a>
                </div>
            </h2>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="panel panel-default">
                <div class="panel-body text-center">
                    <img src="@Url.Content(Model.ImageUrl ?? "~/Content/images/no-image.png")"
                         alt="@Model.Name" class="img-responsive img-thumbnail" style="max-height: 350px; margin: 0 auto;" />

                    <h3 style="margin-top: 20px; font-weight: bold;">@Model.Name</h3>

                    <div style="margin-top: 10px;">
                        @if (Model.StockQuantity > 0)
                        {
                            <span class="label label-success" style="font-size: 14px;">Còn hàng (@Model.StockQuantity)</span>
                        }
                        else
                        {
                            <span class="label label-danger" style="font-size: 14px;">Hết hàng</span>
                        }
                    </div>
                </div>
            </div>

            <div class="panel panel-info">
                <div class="panel-heading"><h3 class="panel-title">Danh mục phân loại</h3></div>
                <div class="panel-body">
                    @if (Model.ProductNavbarLinks != null && Model.ProductNavbarLinks.Any())
                    {
                        <ul class="list-group" style="margin-bottom: 0;">
                            @foreach (var link in Model.ProductNavbarLinks)
                            {
                                <li class="list-group-item"><i class="glyphicon glyphicon-tag"></i> @link.NavbarItem.ItemText</li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted">Chưa thuộc danh mục nào.</p>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-8">

            <div class="panel panel-primary">
                <div class="panel-heading"><h3 class="panel-title">Thông tin chi tiết</h3></div>
                <table class="table table-bordered table-striped">
                    <tbody>
                        <tr><th style="width: 150px;">ID Sản phẩm</th><td>@Model.ProductId</td></tr>
                        <tr><th>Tên sản phẩm</th><td><strong>@Model.Name</strong></td></tr>
                        <tr><th>Giá nhập</th><td>@(Model.PurchasePrice.HasValue ? Model.PurchasePrice.Value.ToString("N0") + "₫" : "Chưa nhập")</td></tr>
                        <tr><th>Giá bán lẻ</th><td style="color: #d0011b; font-weight: bold; font-size: 16px;">@Model.Price.ToString("N0")₫</td></tr>
                        <tr><th>Giảm giá</th><td>@(Model.DiscountPercentage > 0 ? Model.DiscountPercentage + "%" : "-")</td></tr>
                        <tr><th>Ngày tạo</th><td>@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td></tr>
                        <tr>
                            <th>Mô tả</th>
                            <td>@(string.IsNullOrEmpty(Model.Description) ? "Không có" : Html.Raw(Model.Description.Replace("\n", "<br>")))</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="panel panel-success">
                <div class="panel-heading">
                    <h3 class="panel-title"><i class="glyphicon glyphicon-transfer"></i> Lịch sử Nhập / Xuất Kho</h3>
                </div>
                <div class="panel-body" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-condensed table-hover">
                        <thead>
                            <tr>
                                <th>Ngày giờ</th>
                                <th>Loại GD</th>
                                <th>Số lượng</th>
                                <th>Nhà cung cấp</th>
                                <th>Người làm</th>
                                <th>Ghi chú</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.StockTransactions != null && Model.StockTransactions.Any())
                            {
                                foreach (var trans in Model.StockTransactions.OrderByDescending(t => t.CreatedAt))
                                {
                                    <tr>
                                        <td>@(trans.CreatedAt.HasValue ? trans.CreatedAt.Value.ToString("dd/MM HH:mm") : "")</td>
                                        <td>
                                            @if (trans.Type == 1)
                                            {<span class="label label-success">Nhập</span> }
                                            else
                                            { <span class="label label-danger">Xuất trả</span>}
                                        </td>
                                        <td><strong>@trans.Quantity</strong></td>
                                        <td>@(trans.Supplier != null ? trans.Supplier.Name : "-")</td>

                                        @* === ĐÃ SỬA: HIỆN TÊN USER === *@
                                    <td>
                                        @if (trans.User != null)
                                        {
                                            @* SỬA LỖI: Ghép FirstName và LastName thay vì dùng FullName *@
                                            string fullName = (trans.User.FirstName + " " + trans.User.LastName).Trim();

                                            if (!string.IsNullOrEmpty(fullName))
                                            {
                                                <span>@fullName</span> <br />
                                                <small class="text-muted">(@trans.User.Username)</small>
                                            }
                                            else
                                            {
                                                <span>@trans.User.Username</span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">ID: @trans.UserId</span>
                                        }
                                    </td>

                                        <td>@trans.Note</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="6" class="text-center text-muted">Chưa có giao dịch kho nào.</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="panel panel-warning">
                <div class="panel-heading">
                    <h3 class="panel-title"><i class="glyphicon glyphicon-time"></i> Nhật ký thay đổi thông tin</h3>
                </div>
                <div class="panel-body" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 140px;">Thời gian</th>
                                <th style="width: 100px;">Người sửa</th>
                                <th>Hành động</th>
                                <th>Chi tiết</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.ProductLogs != null && Model.ProductLogs.Any())
                            {
                                foreach (var log in Model.ProductLogs.OrderByDescending(l => l.CreatedAt))
                                {
                                    <tr>
                                        <td style="font-size: 12px;">@log.CreatedAt.Value.ToString("dd/MM/yyyy HH:mm")</td>

                                        @* UpdatedBy là string (lưu tên) nên hiển thị trực tiếp *@
                                        <td><span class="label label-default">@log.UpdatedBy</span></td>

                                        <td>
                                            @if (log.ActionType != null && log.ActionType.Contains("Nhập"))
                                            {<span class="text-success bold">@log.ActionType</span> }
                                        else if (log.ActionType != null && log.ActionType.Contains("Xuất"))
                                        { <span class="text-danger bold">@log.ActionType</span> }
                                    else
                                    { <span>@log.ActionType</span>}
                                        </td>
                                        <td style="font-size: 13px;">@log.LogDescription</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="4" class="text-center text-muted">Chưa có lịch sử thay đổi nào.</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>