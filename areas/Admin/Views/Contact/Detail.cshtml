@model PhoneStore_New.Models.Contact
@{
    ViewBag.Title = "Chi tiết yêu cầu";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="row">
    <div class="col-md-8 col-md-offset-2">
        <h3 class="page-header">Chi tiết Phiếu hỗ trợ #@Model.Id</h3>

        @* 1. THÔNG TIN KHÁCH HÀNG *@
        <div class="panel panel-info">
            <div class="panel-heading">Thông tin người gửi</div>
            <div class="panel-body">
                <p><strong>Họ tên:</strong> @Model.FullName</p>
                <p><strong>Email:</strong> @Model.Email</p>
                <p><strong>SĐT:</strong> @Model.Phone</p>
                <hr />
                <p><strong>Nội dung gốc:</strong></p>
                <div class="well well-sm">@Model.Message</div>
            </div>
        </div>

        @* 2. LỊCH SỬ CHAT *@
        <h4 style="margin-top:30px;">Lịch sử trao đổi</h4>

        @* THÊM ID="adminChatBox" *@
        <div class="chat-panel panel panel-default">
            <div class="panel-body" id="adminChatBox" style="height: 400px; overflow-y: scroll; background-color: #f5f5f5;">

                @* Tin nhắn gốc *@
                <div class="alert alert-warning text-left" style="width: 80%; float: left;">
                    <strong>Khách hàng:</strong> <br />
                    @Model.Message
                    <br /><small class="text-muted">@(Model.CreatedAt.HasValue ? Model.CreatedAt.Value.ToString("dd/MM/yyyy HH:mm") : "")</small>
                </div>
                <div class="clearfix"></div>

                @* Các tin nhắn trả lời *@
                @if (ViewBag.Replies != null)
                {
                    foreach (var reply in ViewBag.Replies as List<PhoneStore_New.Models.ContactReply>)
                    {
                        // Kiểm tra ai chat để căn trái/phải
                        bool isAdmin = reply.IsAdmin == true;

                        <div class="alert @(isAdmin ? "alert-success text-right" : "alert-warning text-left")"
                             style="width: 80%; float: @(isAdmin ? "right" : "left");">

                            <strong>@(isAdmin ? "Quản trị viên (Bạn)" : "Khách hàng"):</strong> <br />
                            @reply.Message
                            <br />
                            <small class="text-muted">
                                @(reply.CreatedAt.HasValue ? reply.CreatedAt.Value.ToString("dd/MM/yyyy HH:mm") : "")
                            </small>
                        </div>
                        <div class="clearfix"></div>
                    }
                }
            </div>
        </div>

        @* 3. FORM TRẢ LỜI *@
        <div class="panel panel-primary" style="margin-top: 20px;">
            <div class="panel-heading"><i class="fa fa-pencil"></i> Viết câu trả lời</div>
            <div class="panel-body">
                @using (Html.BeginForm("Reply", "Contact", FormMethod.Post))
                {
                    <input type="hidden" name="contactId" value="@Model.Id" />
                    <div class="form-group">
                        @* THÊM ID="adminMsgInput" *@
                        <textarea id="adminMsgInput" name="message" class="form-control" rows="4" placeholder="Nhập nội dung phản hồi..." required></textarea>
                    </div>
                    <div class="text-right">
                        <a href="@Url.Action("Index")" class="btn btn-default">Quay lại</a>
                        <button type="submit" class="btn btn-primary">Gửi trả lời</button>
                    </div>
                }
            </div>
        </div>
        <br /><br />
    </div>
</div>

@* SCRIPT TỰ ĐỘNG CUỘN *@
<script>
    // Hàm này chạy ngay khi trang load xong
    window.onload = function() {
        // 1. Tìm khung chat và kéo xuống cuối
        var chatBox = document.getElementById("adminChatBox");
        if(chatBox) {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // 2. Tìm ô nhập liệu và focus vào nó
        var input = document.getElementById("adminMsgInput");
        if(input && input.value === "") {
            input.focus();
        }
    };
</script>